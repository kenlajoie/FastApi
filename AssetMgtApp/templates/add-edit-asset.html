{% include 'layout.html' %}

<div class="container">
  <div class="card mt-5">
     <div class="card-header p-1">
         <h5 class="card-title card-title-left">Asset</h5>
     </div>
     <div class="card-body">
        {% if mode == "ADD"%}
        <form id="addAssetForm">
        {% endif %}
        {% if mode == "EDIT"%}
        <form id="editAssetForm">
        {% endif %}

            <div class="form-group">
              <input type="text" class="form-control" name="mode" value="{{mode}}" hidden>
            </div>

            <div class="row g-5 pt-0">
                <div class="col-sm-3">
                    <label for="majorArea" class="form-label-sm">Major Area</label>
                    <select id="majorArea" name="majorArea"
                        style="min-width: 125px; max-width: 125px;" class="form-control-sm mb-1">
                        {% for ddv in dropdown %}
                          {% if ddv.column == "MAJORAREA" %}
                              {% if ddv.value == asset.majorArea %}
                                 <option value="{{ddv.value}}" selected>{{ddv.value}}</option>
                              {% else %}
                                 <option value="{{ddv.value}}">{{ddv.value}}</option>
                              {% endif %}
                          {% endif %}
                        {% endfor %}
                   </select>
                </div>  <!-- col -->

                <div class="col-sm-3">
                    <label for="minorArea" class="form-label-sm">Minor Area</label>
                    <select id="minorArea" name="minorArea"
                        style="min-width: 125px; max-width: 125px;" class="form-control-sm">
                        {% for ddv in dropdown %}
                          {% if ddv.column == "MINORAREA" %}
                              {% if ddv.value == asset.minorArea %}
                                 <option value="{{ddv.value}}" selected>{{ddv.value}}</option>
                              {% else %}
                                 <option value="{{ddv.value}}">{{ddv.value}}</option>
                              {% endif %}
                          {% endif %}
                        {% endfor %}
                    </select>
                </div>  <!-- col -->

                <div class="col-sm-3">
                    <label for="assetType" class="form-label-sm">Type</label>
                    <select id="assetType" name="assetType"
                        style="min-width: 125px; max-width: 125px;" class="form-control-sm">
                        {% for ddv in dropdown %}
                          {% if ddv.column == "ASSETTYPE" %}
                              {% if ddv.value == asset.assetType %}
                                 <option value="{{ddv.value}}" selected>{{ddv.value}}</option>
                              {% else %}
                                 <option value="{{ddv.value}}">{{ddv.value}}</option>
                              {% endif %}
                          {% endif %}
                        {% endfor %}
                    </select>
                </div>  <!-- col -->
            </div> <!--row-->

            <div class="row g-3 pt-0">
                <div class="col-sm-10">
                    <label for="description" class="form-label-sm">Asset</label>
                    <input id=description name="description" type="text"
                            style="min-width: 350px; max-width: 350px;" class="form-control-sm"
                            placeholder="Asset Description" value="{{asset.description}}" required>
                    <div><span id="error-description" class="error"></span></div>

                </div>  <!-- col -->
            </div> <!--row-->

             <div class="row g-3 pt-1">
                <div class="col-sm-10">
                    <label for="model" class="form-label-sm">Model</label>
                    <select id="model" name="model"
                        style="min-width: 125px; max-width: 125px;" class="form-control-sm">
                        <option value="">Choose...</option>
                        {% for ddv in dropdown %}
                          {% if ddv.column == "MODEL" %}
                              {% if ddv.value == asset.model %}
                                 <option value="{{ddv.value}}" selected>{{ddv.value}}</option>
                              {% else %}
                                 <option value="{{ddv.value}}">{{ddv.value}}</option>
                              {% endif %}
                          {% endif %}
                        {% endfor %}
                    </select>

                    <label for="assetState" class="form-label-sm">State</label>
                    <select id="assetState" name="assetState"
                        style="min-width: 125px; max-width: 125px;" class="form-control-sm">
                        {% for ddv in dropdown %}
                          {% if ddv.column == "ASSETSTATE" %}
                              {% if ddv.value == asset.assetState %}
                                 <option value="{{ddv.value}}" selected>{{ddv.value}}</option>
                              {% else %}
                                 <option value="{{ddv.value}}">{{ddv.value}}</option>
                              {% endif %}
                          {% endif %}
                        {% endfor %}
                    </select>
                </div>  <!-- col -->
            </div> <!--row-->

            <div class="row g-3 pt-1">
                <div class="col-sm-10">
                    <label for="satellite" class="form-label-sm">Satellite</label>
                    <select id="satellite" name="satellite"
                        style="min-width: 125px; max-width: 125px;" class="form-control-sm">
                        <option value="">Choose...</option>
                        {% for ddv in dropdown %}
                          {% if ddv.column == "SATELLITE" %}
                              {% if ddv.value == asset.satellite %}
                                 <option value="{{ddv.value}}" selected>{{ddv.value}}</option>
                              {% else %}
                                 <option value="{{ddv.value}}">{{ddv.value}}</option>
                              {% endif %}
                          {% endif %}
                        {% endfor %}
                    </select>

                    <label for="station" class="form-label-sm">Station</label>
                    <input id=station name="station" type="text"
                        style="min-width: 100px; max-width: 100px;" class="form-control-sm"
                        placeholder="Station" value="{{asset.station}}">
                </div>  <!-- col -->
            </div> <!--row-->

            <div class="row g-3 pt-1">
                <div class="col-sm-10">
                    <label for="gpsLat" class="form-label-sm">Lat:</label>
                    <input name=gpsLat id=gpsLat type="number" step="0.0000001"
                        style="min-width: 105px; max-width: 105px;" class="form-control-sm"
                        placeholder="Latitude" value="{{asset.gpsLat}}" readonly>
                    <span id="error-gpsLat" class="error"></span>

                    <label for="gpsLng" class="form-label-sm">Lng:</label>
                    <input name=gpsLng id=gpsLng type="number" step="0.0000001"
                        style="min-width: 105px; max-width: 105px;" class="form-control-sm"
                        placeholder="longitude" value="{{asset.gpsLng}}" readonly>
                    <span id="error-gpsLng" class="error"></span>

                        <button name=capture id=capture class="btn-sm btn-primary btn-thin-sm"
                            onclick="captureLocation()" type="button">Capture</button>

                        <button name=locate id=locate class="btn-sm btn-primary btn-thin-sm"
                            onclick="clearLocation()" type="button">Clear</button>
                </div> <!-- col -->
            </div> <!--row-->

            <div class="row g-3 pt-1">
                <div class="col-sm-10">
                    <label for="distance" class="form-label-sm">Distance to Major Area</label>
                    <input name=distance id=distance type="number"
                        style="min-width: 100px; max-width: 100px;" class="form-control-sm"
                        placeholder="Distance" value="{{asset.distance}}">
                    <span id="error-distance" class="error"></span>

                    <button name=compute id=compute class="btn-sm btn-primary btn-thin-sm"
                        onclick="computeDistance(true)" type="button">Compute</button>

                </div>  <!-- col -->
            </div> <!--row-->

            <div class="row g-3 pt-1">
                <div class="col-sm-8">
                    <div>
                        <p id="location"></p>
                    </div>
                </div> <!-- col -->
            </div> <!--row-->

            <hr style="border: 1px solid #333; margin: 19px 0px 5px 0px;">

            {% if mode != "ADD"%}
            <div class="row g-3 pt-1">
                <div class="col-sm-8">
                    <b>&nbsp;Created On:</b> {{asset.createdDate}}   <b>By: </b>{{asset.createdBy}}
                </div> <!-- col -->
            </div> <!--row-->
            <div class="row g-3 pt-1">
                <div class="col-sm-8">
                    <b>Updated On:</b> {{asset.updatedDate}}   <b>By: </b>{{asset.updatedBy}}
                </div> <!-- col -->
            </div> <!--row-->
            {% endif %}

            <div class="row g-3 pt-1">
                <div class="col-sm-3">
                    <button type="submit" class="btn-sm btn-primary btn-thin-sm">Save</button>
                    <button class="btn-sm btn-primary btn-thin-sm"
                            onclick=window.location.href='/assets/asset-page' type="button">Back</button>
                </div> <!-- col -->
            </div> <!--row-->
        </form>
     </div> <!-- card body -->
  </div> <!-- card -->
</div>  <!-- container -->



<script>
    const majorAreaPosition = {
    {% for ddv in dropdown %}
      {% if ddv.column == "MAJORAREA" %}
          "{{ddv.value}}" : { gpsLat:{% if ddv.gpsLat is none %}null{% else %}{{ddv.gpsLat}}{% endif %},
                    gpsLng: {% if ddv.gpsLng is none %}null{% else %}{{ddv.gpsLng}}{% endif %} },
      {% endif %}
    {% endfor %}
    };

    function clearLocation() {
        document.getElementById('gpsLat').value = null;
        document.getElementById('gpsLng').value = null;
    }

    function captureLocation() {

        if (navigator.geolocation) {
            const options = {
                enableHighAccuracy: true,  // Use high accuracy if available
                timeout: 5000,             // Timeout of 5 seconds for the request
                maximumAge: 0              // Do not allow cached positions
            };

            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            document.getElementById("location").innerHTML = "Geolocation is not supported by this browser.";
        }
    }

    function computeDistance(showErrors) {

        let assetGpsLat=document.getElementById('gpsLat').value;
        if (!assetGpsLat) {
           if (showErrors)
                document.getElementById("location").innerHTML = "GPS Latitude missing.";
           return;
        }

        let assetGpsLng=document.getElementById('gpsLng').value;
        if (!assetGpsLng) {
           if (showErrors)
              document.getElementById("location").innerHTML = "GPS Longitude missing.";
           return;
        }

        let majorArea=document.getElementById('majorArea').value;
        let majorAreaGpsLat = majorAreaPosition[majorArea].gpsLat;
        let majorAreaGpsLng = majorAreaPosition[majorArea].gpsLng;

        if (!majorAreaGpsLat) {
           if (showErrors)
               document.getElementById("location").innerHTML = "MajorArea GPS Latitude missing.";
           return;
        }

        if (!majorAreaGpsLng) {
           if (showErrors)
               document.getElementById("location").innerHTML = "MajorArea GPS Longitude missing.";
           return;
        }
        //alert(`${assetGpsLat} : ${assetGpsLng} -- ${majorAreaGpsLat} : ${majorAreaGpsLng}`);
        distanceK =  haversine(majorAreaGpsLat, majorAreaGpsLng, assetGpsLat, assetGpsLng);
        distanceYards =  Math.floor(distanceK * 1093.613298);
        distanceFt =  Math.floor(distanceK * 3280.84);
        //alert(`distanceK ${distanceK} -- distanceYards ${distanceYards} distance Ft ${distanceFt}`);
        document.getElementById('distance').value = distanceYards;
    }

    function showPosition(position) {
        document.getElementById('gpsLat').value = position.coords.latitude;
        document.getElementById('gpsLng').value = position.coords.longitude;
    }

    function showError(error) {
        switch (error.code) {
            case error.PERMISSION_DENIED:
                document.getElementById("location").innerHTML = "User denied the request for Geolocation.";
                break;
            case error.POSITION_UNAVAILABLE:
                document.getElementById("location").innerHTML = "Location information is unavailable.";
                break;
            case error.TIMEOUT:
                document.getElementById("location").innerHTML = "The request to get user location timed out.";
                break;
            case error.UNKNOWN_ERROR:
                document.getElementById("location").innerHTML = "An unknown error occurred.";
                break;
        }
    }

    function haversine(lat1, lon1, lat2, lon2) {
        // Radius of the Earth in kilometers
        const R = 6371;

        // Convert latitude and longitude from degrees to radians
        const phi1 = lat1 * Math.PI / 180;
        const phi2 = lat2 * Math.PI / 180;
        const deltaPhi = (lat2 - lat1) * Math.PI / 180;
        const deltaLambda = (lon2 - lon1) * Math.PI / 180;

        // Haversine formula
        const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                  Math.cos(phi1) * Math.cos(phi2) *
                  Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        // Distance in kilometers
        const distance = R * c;

        return distance;
    }
</script>
